I"^<h1 id="데이터베이스를-사용해보자">데이터베이스를 사용해보자</h1>

<p><code class="language-plaintext highlighter-rouge">ToDo List</code>에서 가장 묵혀두었던 주제인데요. 안 될 것 같으면서도 될 것 같아서 흐지부지하고만 있었습니다.</p>

<p>파이썬으로 코딩테스트 준비만 하다가 <code class="language-plaintext highlighter-rouge">JS</code>와 <code class="language-plaintext highlighter-rouge">Spring</code>을 잊어버리지는 않을까 해서 그런 핑계로 테스트 해봤습니다.</p>

<p>정적웹에서 데이터베이스를 이용하자니 java나 nodejs등을 써야하는데 nodejs는 그저 조금 써봤고, java를 구동하자니 github 페이지를 spring으로 구현하는 방법은 모르겠고 해서 조금의 꼼수를 생각해봤습니다.</p>

<blockquote>
  <p>필요한 준비물</p>
  <ol>
    <li>heroku app</li>
    <li>jquery ( AJAX )</li>
    <li>MySQL</li>
    <li>Spring Boot (Spring이나 JSP도 가능하다 생각됩니다.)</li>
  </ol>
</blockquote>

<blockquote>
  <p>Used</p>
  <ol>
    <li>spring-boot-starter-* 2.5.4</li>
    <li>spring-boot-configuration-processor 2.5.4</li>
    <li>tomcat-embed0jasper[privided] 9.0.52</li>
    <li>mybatis-spring-boot-starter 2.2.0</li>
    <li>mysql-connector-java 8.0.26</li>
    <li>lombok 1.18.20</li>
  </ol>
</blockquote>

<h2 id="외부-데이터베이스-사용-구현">외부 데이터베이스 사용 구현</h2>

<p>우선 생각은 이랬습니다.</p>

<ol>
  <li>헤로쿠 앱을 하나 생성한다.</li>
  <li>외부 저장소를 하나 만든다. (JawsDB를 채택했습니다.)</li>
  <li><code class="language-plaintext highlighter-rouge">restful</code> 하게 만들어 <code class="language-plaintext highlighter-rouge">JSON</code>으로 데이터를 주고 받는다.</li>
  <li><code class="language-plaintext highlighter-rouge">table</code>을 만드는 <code class="language-plaintext highlighter-rouge">query</code>도 만든다. (<code class="language-plaintext highlighter-rouge">table</code>을 정적 웹상에서 <code class="language-plaintext highlighter-rouge">form</code>으로 만들고 지우는 것)</li>
</ol>

<p>그래서 저는 테스트용으로 <code class="language-plaintext highlighter-rouge">heroku app</code>을 채택했습니다. <code class="language-plaintext highlighter-rouge">spring</code>으로 서버 구현이 쉽기도 하고 데이터베이스를 무료로 사용할 수 있게 add on을 지원해주기 때문입니다.</p>

<blockquote>
  <p>heroku에서 db를 사용할 때 clearDB는 utf8이 지원이 안되어서 jawsDB를 사용하는 것을 추천드립니다.</p>
</blockquote>

<h3 id="헤로쿠-앱-생성">헤로쿠 앱 생성</h3>

<p><img src="/assets/images/post/database/db02.png" alt="헤로쿠" /></p>

<p>먼저 헤로쿠 앱 하나를 생성합니다. 그리고 Spring Boot로 프로젝트 하나를 만듭니다.</p>

<p><code class="language-plaintext highlighter-rouge">add-on</code>을 <code class="language-plaintext highlighter-rouge">jawsDB</code>로 추가시키고 저장소 <code class="language-plaintext highlighter-rouge">url</code>과 <code class="language-plaintext highlighter-rouge">username</code>, <code class="language-plaintext highlighter-rouge">password</code>, <code class="language-plaintext highlighter-rouge">dbname</code>을 <code class="language-plaintext highlighter-rouge">spring boot</code>의 <code class="language-plaintext highlighter-rouge">properties</code>에 추가할 것이기 때문에 알아둬야합니다.</p>

<p>위 이미지의 <code class="language-plaintext highlighter-rouge">jawsDB MySQL</code>을 클릭하면 본인의 <code class="language-plaintext highlighter-rouge">db</code>정보를 볼 수 있습니다.</p>

<h3 id="spring-boot-prj-설정">Spring boot prj 설정</h3>

<p>프로젝트는 <code class="language-plaintext highlighter-rouge">RestController</code> 하나는 사용해볼 것이므로 딱히 <code class="language-plaintext highlighter-rouge">view</code>단의 파일들은 필요 없습니다.</p>

<div class="language-properties highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="rouge-code"><pre><span class="c"># mysql settings
</span><span class="py">spring.datasource.driver-class-name</span><span class="p">=</span><span class="s">com.mysql.cj.jdbc.Driver</span>
<span class="py">spring.datasource.url</span><span class="p">=</span><span class="s">jdbc:mysql://{hostName}:3306/{databaseName}?useUnicode=yes&amp;characterEncoding=UTF-8&amp;maxActive=20&amp;allowMultiQueries=true&amp;serverTimezone=Asia/Seoul</span>
<span class="py">spring.datasource.username</span><span class="p">=</span> <span class="s">{Id}</span>
<span class="py">spring.datasource.password</span><span class="p">=</span> <span class="s">{Password}</span>

<span class="py">mybatis.type-aliases-package</span><span class="p">=</span><span class="s">com.repotest.web.entity</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>프로퍼티파일은 위와 같이 설정했습니다. 콧수염 괄호(“{“, “}”) 는 빼고 입력하시면 됩니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre></td><td class="rouge-code"><pre><span class="c1">// ServletConfig.java</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableWebMvc</span>
<span class="nd">@ComponentScan</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"com.repotest.web"</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ServletConfig</span> <span class="kd">implements</span> <span class="nc">WebMvcConfigurer</span> <span class="o">{</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">addCorsMappings</span><span class="o">(</span><span class="nc">CorsRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">registry</span><span class="o">.</span><span class="na">addMapping</span><span class="o">(</span><span class="s">"/**"</span><span class="o">).</span><span class="na">allowedOrigins</span><span class="o">(</span><span class="s">"localhost:8080/"</span><span class="o">,</span> <span class="s">"your herokuapp baseurl"</span><span class="o">).</span><span class="na">allowedMethods</span><span class="o">(</span>
            <span class="c1">// "GET","POST","PUT","DELETE"</span>
            <span class="nc">HttpMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">.</span><span class="na">name</span><span class="o">(),</span> <span class="nc">HttpMethod</span><span class="o">.</span><span class="na">HEAD</span><span class="o">.</span><span class="na">name</span><span class="o">(),</span> <span class="nc">HttpMethod</span><span class="o">.</span><span class="na">POST</span><span class="o">.</span><span class="na">name</span><span class="o">(),</span> <span class="nc">HttpMethod</span><span class="o">.</span><span class="na">PUT</span><span class="o">.</span><span class="na">name</span><span class="o">(),</span>
            <span class="nc">HttpMethod</span><span class="o">.</span><span class="na">DELETE</span><span class="o">.</span><span class="na">name</span><span class="o">());</span>
    <span class="o">}</span>
    
	<span class="nd">@Override</span>
	<span class="kd">public</span> <span class="kt">void</span> <span class="nf">addResourceHandlers</span><span class="o">(</span><span class="nc">ResourceHandlerRegistry</span> <span class="n">registry</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">registry</span><span class="o">.</span><span class="na">addResourceHandler</span><span class="o">(</span><span class="s">"/resources/**"</span><span class="o">)</span> <span class="c1">// 매핑 URI 설정</span>
				<span class="o">.</span><span class="na">addResourceLocations</span><span class="o">(</span><span class="s">"/resources/"</span><span class="o">);</span> <span class="c1">// 정적 리소스 위치 설정</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">servletconfig.java</code>를 생성합니다. <code class="language-plaintext highlighter-rouge">cors</code>매핑과 <code class="language-plaintext highlighter-rouge">resources</code> 경로를 잡아줍니다.</p>

<p>resources 매핑은 굳이 필요 없다고 생각되지만 나중에 <code class="language-plaintext highlighter-rouge">js</code>등을 연결해서 데이터를 중간에서 가공할 때 필요할 것 같아 작성 해두었습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="c1">// WebConfig.java</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableWebMvc</span>
<span class="nd">@ComponentScan</span><span class="o">(</span><span class="n">basePackages</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"com.repotest.web"</span> <span class="o">})</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">WebConfig</span> <span class="kd">extends</span> <span class="nc">AbstractAnnotationConfigDispatcherServletInitializer</span><span class="o">{</span>
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">getRootConfigClasses</span><span class="o">()</span>
	<span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">[]</span> <span class="o">{};</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="nc">Class</span><span class="o">&lt;?&gt;[]</span> <span class="n">getServletConfigClasses</span><span class="o">()</span>
	<span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nc">Class</span><span class="o">[]</span> <span class="o">{</span><span class="nc">ServletConfig</span><span class="o">.</span><span class="na">class</span><span class="o">};</span>
	<span class="o">}</span>

	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="nc">String</span><span class="o">[]</span> <span class="nf">getServletMappings</span><span class="o">()</span>
	<span class="o">{</span>
		<span class="k">return</span> <span class="k">new</span> <span class="nc">String</span><span class="o">[]</span> <span class="o">{</span><span class="s">"/"</span><span class="o">};</span>
	<span class="o">}</span>
	
	<span class="nd">@Override</span>
	<span class="kd">protected</span> <span class="nc">Filter</span><span class="o">[]</span> <span class="nf">getServletFilters</span><span class="o">()</span> <span class="o">{</span>
		<span class="nc">HiddenHttpMethodFilter</span> <span class="n">httpMethodFilter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">HiddenHttpMethodFilter</span><span class="o">();</span>
	    <span class="nc">CharacterEncodingFilter</span> <span class="n">encodingFilter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CharacterEncodingFilter</span><span class="o">();</span>
	    <span class="n">encodingFilter</span><span class="o">.</span><span class="na">setEncoding</span><span class="o">(</span><span class="s">"UTF-8"</span><span class="o">);</span>
	    <span class="n">encodingFilter</span><span class="o">.</span><span class="na">setForceEncoding</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
	    <span class="k">return</span> <span class="k">new</span> <span class="nc">Filter</span><span class="o">[]</span> <span class="o">{</span> <span class="n">httpMethodFilter</span><span class="o">,</span> <span class="n">encodingFilter</span> <span class="o">};</span>
	<span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>필터도 하나 만들어 줍니다. 가끔 한글이 깨지는 것을 경험하고 난 후로는 모든 프로젝트에 추가하고 있습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c1">// MemberMapper.java</span>

<span class="nd">@Mapper</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MemberMapper</span> <span class="o">{</span>
	<span class="nd">@Select</span><span class="o">(</span><span class="s">"SELECT * FROM member"</span><span class="o">)</span>
	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">getList</span><span class="o">();</span>
	<span class="nd">@Select</span><span class="o">(</span><span class="s">"select * from member where concat(id,name,age,gender) like '%#{word}%'"</span><span class="o">)</span>
	<span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">getListByWord</span><span class="o">(</span><span class="nc">String</span> <span class="n">word</span><span class="o">);</span>
	<span class="nd">@Insert</span><span class="o">(</span><span class="s">"INSERT INTO member(name, age, gender) VALUES(#{name}, #{age}, #{gender})"</span><span class="o">)</span>
	<span class="kt">void</span> <span class="nf">addMember</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">);</span>
	<span class="nd">@Update</span><span class="o">(</span><span class="s">"UPDATE member SET name=#{name}, age=#{age}, gender=#{gender}"</span><span class="o">)</span>
	<span class="kt">void</span> <span class="nf">editMember</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">);</span>
	<span class="nd">@Delete</span><span class="o">(</span><span class="s">"DELETE FROM member WHERE id=#{id}"</span><span class="o">)</span>
	<span class="kt">void</span> <span class="nf">removeMember</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">);</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">mybatis mapper</code>는 최소한으로 <code class="language-plaintext highlighter-rouge">CRUD</code>만 테스트해보겠습니다.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
</pre></td><td class="rouge-code"><pre><span class="c1">// HomeController.java</span>

<span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="o">(</span><span class="s">"/"</span><span class="o">)</span>
<span class="nd">@CrossOrigin</span><span class="o">(</span><span class="n">origins</span> <span class="o">=</span> <span class="s">"*"</span><span class="o">,</span> <span class="n">allowedHeaders</span> <span class="o">=</span> <span class="s">"*"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">HomeController</span> <span class="o">{</span>
	
	<span class="nd">@Autowired</span>
	<span class="nc">MemberServiceImpl</span> <span class="n">service</span><span class="o">;</span>
	
	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">""</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">String</span> <span class="nf">home</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="s">"hello world"</span><span class="o">;</span>
	<span class="o">}</span>
	
	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"member"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">memberlist</span><span class="o">()</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="na">getList</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="nd">@GetMapping</span><span class="o">(</span><span class="s">"member/{word}"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">memberadd</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"word"</span><span class="o">)</span> <span class="nc">String</span> <span class="n">word</span><span class="o">)</span> <span class="o">{</span>
		<span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="na">getListByWord</span><span class="o">(</span><span class="n">word</span><span class="o">);</span>
	<span class="o">}</span>
	
	<span class="nd">@PostMapping</span><span class="o">(</span><span class="s">"member"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">memberadd</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">service</span><span class="o">.</span><span class="na">addMember</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="na">getList</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="nd">@PutMapping</span><span class="o">(</span><span class="s">"member/{id}"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">memberedit</span><span class="o">(</span><span class="nc">Member</span> <span class="n">member</span><span class="o">,</span> <span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">member</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
		<span class="n">service</span><span class="o">.</span><span class="na">editMember</span><span class="o">(</span><span class="n">member</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="na">getList</span><span class="o">();</span>
	<span class="o">}</span>
	
	<span class="nd">@DeleteMapping</span><span class="o">(</span><span class="s">"member/{id}"</span><span class="o">)</span>
	<span class="kd">public</span> <span class="nc">List</span><span class="o">&lt;</span><span class="nc">Member</span><span class="o">&gt;</span> <span class="nf">memberremove</span><span class="o">(</span><span class="nd">@PathVariable</span><span class="o">(</span><span class="s">"id"</span><span class="o">)</span> <span class="kt">int</span> <span class="n">id</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">service</span><span class="o">.</span><span class="na">removeMember</span><span class="o">(</span><span class="n">id</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">service</span><span class="o">.</span><span class="na">getList</span><span class="o">();</span>
	<span class="o">}</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>service와 entity부분은 생략하겠습니다. 컨트롤러는 RestController를 사용하여 나중에 정적웹에서 JSON으로 받을 준비를 합니다.</p>

<p><img src="/assets/images/post/database/db03.png" alt="스프링" /></p>

<p>그러고나서 스프링 부트를 실행하고 확인해봅니다. 위와 같이 나오면 성공입니다.</p>

<h3 id="데이터베이스-서버-테스트">데이터베이스 서버 테스트</h3>

<p>헤로쿠에 spring boot 프로젝트를 배포합니다.</p>

<p>배포 방법을 남겨두겠습니다. 이클립스를 사용하고 있어 이클립스 기준으로 설명하겠습니다.</p>

<blockquote>
  <p>pom.xml에 version태그 밑 packaging태그가 war라면 jar로 바꾸어 줍니다.</p>
</blockquote>

<p>이클립스에서 <code class="language-plaintext highlighter-rouge">run as &gt; maven build &gt; Goals</code>에 package라고 적습니다.
<code class="language-plaintext highlighter-rouge">profiles</code>에 pom.xml은 빌드 했을때 오류가 발생하면서 빌드 실패한다면 <code class="language-plaintext highlighter-rouge">profiles</code>란을 비우고 다시 빌드합니다.</p>

<p>이후 <code class="language-plaintext highlighter-rouge">cmd</code>나 <code class="language-plaintext highlighter-rouge">bash</code>를 열어 <code class="language-plaintext highlighter-rouge">heroku</code>에 배포합니다. 이 때 <code class="language-plaintext highlighter-rouge">build</code>된 파일은 해당 프로젝트 <code class="language-plaintext highlighter-rouge">target</code>폴더에 위치하며, 프로젝트 파일의 위치에서 <code class="language-plaintext highlighter-rouge">bash</code>를 엽니다.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre>git init
heroku git:remote <span class="nt">-a</span> appname
git add <span class="nb">.</span>
git commit <span class="nt">-am</span> <span class="s2">"make it better"</span>
git push heroku master
</pre></td></tr></tbody></table></code></pre></div></div>

<p>프로젝트가 헤로쿠 git에 업로드 되고 알아서 java를 인식합니다.</p>

<p>완료가 되면 https://appname.herokuapp.com으로 접속해서 확인합니다.</p>

<p><img src="/assets/images/post/database/db03.png" alt="스프링" /></p>

<p>위와 같이 이클립스에서 로컬호스트로 접속했을 때와 같다면 성공입니다. 그리고 <code class="language-plaintext highlighter-rouge">member</code>경로를 테스트 해봅니다.</p>

<p><img src="/assets/images/post/database/db04.png" alt="스프링" /></p>

<p>잘 뜹니다. 이제 저장소로 쓸 서버를 만들었으니 본인의 깃허브 페이지나 http 서버를 하나 엽니다.</p>

<h3 id="데이터베이스로-사용하기">데이터베이스로 사용하기</h3>

<p>모든 준비가 끝났습니다. 저는 local</p>
:ET