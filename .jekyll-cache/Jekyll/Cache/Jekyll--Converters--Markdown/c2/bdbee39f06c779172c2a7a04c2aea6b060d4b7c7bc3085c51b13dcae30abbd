I"ğE<h1 id="next-authë¥¼-ì‚¬ìš©í•´ë³´ì">Next-Authë¥¼ ì‚¬ìš©í•´ë³´ì</h1>

<p>Next authëŠ” next.js ì•±ì— ì¸ì¦ì„ ì¶”ê°€í•´ì£¼ëŠ” ê³ ë§ˆìš´ ë¼ì´ë¸ŒëŸ¬ë¦¬ì´ë‹¤. NextAuth.js í™ˆí˜ì´ì§€ì—ì„œë„ ë”°ë¼í•˜ê¸° ì‰½ê³ , ì‚¬ìš©í•˜ê³ ì í•˜ëŠ” apië‚˜ optionì— ëŒ€í•´ì„œë„ ë³´ê¸° ì¢‹ê²Œ ì •ë¦¬ë˜ì–´ ìˆë‹¤.</p>

<p>ì´ë²ˆì— í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ì„œ ìœ ì € ì¸ì¦ì„ êµ¬í˜„í•´ì•¼ í•  ì¼ì´ ìƒê²¼ë‹¤. MongoDB ë˜í•œ ì²˜ìŒ ì‚¬ìš©í•˜ë©´ì„œ ì—¬ëŸ¬ê°€ì§€ ë°°ìš¸ ë¶€ë¶„ë„ ë§ê³ , jwt(Json Web Token)ë„ ì²˜ìŒ ì¨ë³´ë©´ì„œ ì§„ì§œ ë¨¸ë¦¬ê°€ í„°ì ¸ë‚˜ê°ˆ ê²ƒë§Œ ê°™ì§€ë§Œ, í•˜ë‚˜ ì”© ë™ì‘í•˜ëŠ” ê±¸ ë³¼ ë•Œë§ˆë‹¤ ê¸°ë¶„ì´ ì¢‹ìœ¼ë‹ˆ ì°¸ê¸°ë¡œ í•œë‹¤.</p>

<h2 id="ì‘ì—…-í™˜ê²½">ì‘ì—… í™˜ê²½</h2>

<blockquote>
  <p>2022-06-08 ê¸°ì¤€</p>
</blockquote>

<ul>
  <li>react: v18.1.0</li>
  <li>next: v12.1.6,</li>
  <li>next-auth: v4.3.4</li>
  <li>MongoDB: v5.3.1 (shell)</li>
  <li>mongoose: v6.3.5</li>
  <li>axios: v0.27.2</li>
</ul>

<h2 id="ê¸°ì¡´-í”„ë¡œì íŠ¸ì—-ì¶”ê°€í•˜ëŠ”-ë°©ë²•">ê¸°ì¡´ í”„ë¡œì íŠ¸ì— ì¶”ê°€í•˜ëŠ” ë°©ë²•</h2>

<p>ë¨¼ì € <code class="language-plaintext highlighter-rouge">next-auth</code>ì˜ ì‘ë™ì›ë¦¬ë¥¼ ì•Œì•„ì•¼í•œë‹¤. ê¸°ë³¸ì ìœ¼ë¡œ ì‘ë™ì€ <code class="language-plaintext highlighter-rouge">next</code>ì˜ <code class="language-plaintext highlighter-rouge">dynamic routes</code>ë¥¼ ì‚¬ìš©í•œë‹¤.</p>

<p>nextì˜ dynamic routesì— ëŒ€í•´ ëª¨ë¥¸ë‹¤ë©´ <a href="https://nextjs.org/docs/routing/dynamic-routes" target="\_blank">ì´ ë§í¬</a> ë¥¼ ë¨¼ì € ì°¸ê³ í•˜ì.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre></td><td class="rouge-code"><pre><span class="c1">// pages/api/auth/[...nextauth].js</span>

<span class="k">import</span> <span class="nx">NextAuth</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">next-auth</span><span class="dl">"</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">GithubProvider</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">next-auth/providers/github</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">NextAuth</span><span class="p">({</span>
  <span class="c1">// Configure one or more authentication providers</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">GithubProvider</span><span class="p">({</span>
      <span class="na">clientId</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GITHUB_ID</span><span class="p">,</span>
      <span class="na">clientSecret</span><span class="p">:</span> <span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">GITHUB_SECRET</span><span class="p">,</span>
    <span class="p">}),</span>
    <span class="c1">// ...add more providers here</span>
  <span class="p">],</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ìœ„ì˜ ì˜ˆì‹œì²˜ëŸ¼ ì‘ì„±í•´ì„œ ì“´ë‹¤. ì˜ˆì‹œ ë‚´ìš©ì€ Githubë¡œê·¸ì¸ êµ¬í˜„ì— ì‚¬ìš©ë˜ëŠ” ì˜ˆì‹œì´ê³  ì•„ì§ í™œìš©í•´ë³´ì§€ëŠ” ëª»í–ˆìœ¼ë‹ˆ ë‹¤ìŒ ê¸°íšŒì— ë‹¤ë¤„ë³´ê¸°ë¡œ í•˜ì.</p>

<p>ë‚´ê°€ ì´ë²ˆì— ì •ë¦¬í•˜ê³  ë‹¤ë£° ë‚´ìš©ì€ <code class="language-plaintext highlighter-rouge">**CredentialsProvider**</code> ë¶€ë¶„ì´ë‹¤. ì˜ˆì‹œ ì„¸íŒ…ì€ ì•„ë˜ì™€ ê°™ë‹¤.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre></td><td class="rouge-code"><pre><span class="c1">// pages/api/auth/[...nextauth].js</span>

<span class="k">import</span> <span class="nx">CredentialsProvider</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">next-auth/providers/credentials</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">NextAuth</span><span class="p">({</span>
  <span class="c1">// Configure one or more authentication providers</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span>
    <span class="c1">// ...ë‹¤ë¥¸ providerë¥¼ ì¶”ê°€í•˜ë©´ ëœë‹¤.</span>
    <span class="nx">CredentialsProvider</span><span class="p">({</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">username-password-credentials</span><span class="dl">"</span><span class="p">,</span>
      <span class="c1">// The name to display on the sign in form (e.g. 'Sign in with...')</span>
      <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Credentials</span><span class="dl">"</span><span class="p">,</span>
      <span class="c1">// The credentials is used to generate a suitable form on the sign in page.</span>
      <span class="c1">// You can specify whatever fields you are expecting to be submitted.</span>
      <span class="c1">// e.g. domain, username, password, 2FA token, etc.</span>
      <span class="c1">// You can pass any HTML attribute to the &lt;input&gt; tag through the object.</span>
      <span class="na">credentials</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">username</span><span class="p">:</span> <span class="p">{</span> <span class="na">label</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Username</span><span class="dl">"</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">,</span> <span class="na">placeholder</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jsmith</span><span class="dl">"</span> <span class="p">},</span>
        <span class="na">password</span><span class="p">:</span> <span class="p">{</span> <span class="na">label</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Password</span><span class="dl">"</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">password</span><span class="dl">"</span> <span class="p">},</span>
      <span class="p">},</span>
      <span class="k">async</span> <span class="nx">authorize</span><span class="p">(</span><span class="nx">credentials</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// You need to provide your own logic here that takes the credentials</span>
        <span class="c1">// submitted and returns either a object representing a user or value</span>
        <span class="c1">// that is false/null if the credentials are invalid.</span>
        <span class="c1">// e.g. return { id: 1, name: 'J Smith', email: 'jsmith@example.com' }</span>
        <span class="c1">// You can also use the `req` object to obtain additional parameters</span>
        <span class="c1">// (i.e., the request IP address)</span>
        <span class="kd">const</span> <span class="nx">res</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/your/endpoint</span><span class="dl">"</span><span class="p">,</span> <span class="p">{</span>
          <span class="na">method</span><span class="p">:</span> <span class="dl">"</span><span class="s2">POST</span><span class="dl">"</span><span class="p">,</span>
          <span class="na">body</span><span class="p">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">credentials</span><span class="p">),</span>
          <span class="na">headers</span><span class="p">:</span> <span class="p">{</span> <span class="dl">"</span><span class="s2">Content-Type</span><span class="dl">"</span><span class="p">:</span> <span class="dl">"</span><span class="s2">application/json</span><span class="dl">"</span> <span class="p">},</span>
        <span class="p">});</span>
        <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">res</span><span class="p">.</span><span class="nx">json</span><span class="p">();</span>

        <span class="c1">// If no error and we have user data, return it</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">ok</span> <span class="o">&amp;&amp;</span> <span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
          <span class="k">return</span> <span class="nx">user</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="c1">// Return null if user data could not be retrieved</span>
        <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
      <span class="p">},</span>
    <span class="p">}),</span>
  <span class="p">],</span>
  <span class="na">pages</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">},</span>
  <span class="na">callbacks</span><span class="p">:</span> <span class="p">{</span>
    <span class="c1">// ...</span>
  <span class="p">},</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>ë¨¼ì € <code class="language-plaintext highlighter-rouge">CredentialsProvider</code>ëŠ” ë¡œê·¸ì¸ êµ¬í˜„ ë•Œ ì‚¬ìš©ë˜ëŠ” ê²ƒì¸ë°, í•˜ë‚˜ ì”© ë³´ì.</p>

<ol>
  <li>id: ì•„ì´ë””ëŠ” ë‚´ê°€ ë‚˜ì¤‘ì— ì‚¬ìš©í•˜ê³ ì í•˜ëŠ” ì¸ì¦ Providerë¥¼ ê³¨ë¼ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ì´ë¦„ì •ë„ë¡œ ë³´ë©´ ëœë‹¤.</li>
  <li>name: <code class="language-plaintext highlighter-rouge">/api/auth/signin</code> ê²½ë¡œë¡œ ì ‘ì†í•˜ê²Œ ë˜ë©´ ë‚˜ì˜¤ëŠ” ë¡œê·¸ì¸ í˜ì´ì§€ì—ì„œ ë¡œê·¸ì¸ ë²„íŠ¼ì— ë„ì–´ì§€ëŠ” <code class="language-plaintext highlighter-rouge">"Sign in with [name]"</code>ì˜ í…ìŠ¤íŠ¸ ë¶€ë¶„ì´ë‹¤. ì¦‰, submit ë²„íŠ¼ í…ìŠ¤íŠ¸ì´ë‹¤.</li>
  <li>credentials: í•´ë‹¹ providerë¥¼ ì‚¬ìš©í•  ë•Œ ì¸ì¦ í•  ìš”ì†Œë¥¼ ì„ íƒí•˜ëŠ” ë¶€ë¶„ì´ë‹¤. ë§ˆì°¬ê°€ì§€ë¡œ <code class="language-plaintext highlighter-rouge">/api/auth/signin</code> ê²½ë¡œë¡œ ì ‘ì†í•˜ë©´ ë‚˜ì˜¤ëŠ” input fieldì— í•´ë‹¹í•œë‹¤.</li>
  <li>authorize: ì‹¤ì§ˆì ìœ¼ë¡œ ë¡œê·¸ì¸ ì²˜ë¦¬ê°€ ë˜ëŠ” ë¡œì§ë¶€ë¶„ì´ë‹¤. <code class="language-plaintext highlighter-rouge">credentials</code>ì—ëŠ” ë‚´ê°€ í•´ë‹¹ í•„ë“œì— ì…ë ¥í•œ input nameê³¼ valueê°’ì´ objectë¡œ ë“¤ì–´ì˜¤ê²Œ ëœë‹¤. reqì—ëŠ” requsetë‚´ìš© ì „ì²´ê°€ ë“¤ì–´ì˜¨ë‹¤. (body, query, headers&#8230; ë“±ë“±)</li>
  <li>pages: <code class="language-plaintext highlighter-rouge">/api/auth/signin</code> ë“±ì˜ ê²½ë¡œë¥¼ ë‚´ê°€ ì§€ì •í•  ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤. (ex. <code class="language-plaintext highlighter-rouge">/auth/login</code>)</li>
  <li>callbacks: session, jwt, redirect, signIn ë©”ì„œë“œë¥¼ ì¬ì •ì˜í•´ì„œ ì»¤ìŠ¤í„°ë§ˆì´ì§• í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ë¶€ë¶„ì´ë‹¤.</li>
</ol>

<p>ì§„ì§œ ì •ë§ ê°„ë‹¨í•˜ê²Œ ì„¤ëª…í•œ ë¶€ë¶„ì´ë¼ ê¼­ í™ˆí˜ì´ì§€ë¥¼ ì°¸ì¡°í•´ì„œ ë” ìì„¸í•˜ê²Œ ë³´ê¸°ë¥¼ ë°”ë€ë‹¤.</p>

<h2 id="ë¡œê·¸ì¸-ì²˜ë¦¬">ë¡œê·¸ì¸ ì²˜ë¦¬</h2>

<p>ìœ„ ì˜ˆì‹œ ì½”ë“œì—ì„œ ë‚˜ëŠ” fetchë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  mongooseë¥¼ ì‚¬ìš©í•˜ì˜€ê¸° ë•Œë¬¸ì— ì¡°ê¸ˆ ë°”ê¾¸ì–´ ë‹¤ì‹œ ë³´ì.</p>

<div class="language-jsx highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="c1">// pages/api/auth/[...nextauth].js</span>

<span class="k">import</span> <span class="nx">CredentialsProvider</span> <span class="k">from</span> <span class="dl">"</span><span class="s2">next-auth/providers/credentials</span><span class="dl">"</span><span class="p">;</span>

<span class="k">export</span> <span class="k">default</span> <span class="nx">NextAuth</span><span class="p">({</span>
  <span class="na">providers</span><span class="p">:</span> <span class="p">[</span>
    <span class="nx">CredentialsProvider</span><span class="p">({</span>
      <span class="na">id</span><span class="p">:</span> <span class="dl">"</span><span class="s2">username-password-credentials</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">name</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Credentials</span><span class="dl">"</span><span class="p">,</span>
      <span class="na">credentials</span><span class="p">:</span> <span class="p">{</span>
        <span class="na">username</span><span class="p">:</span> <span class="p">{</span> <span class="na">label</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Username</span><span class="dl">"</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">text</span><span class="dl">"</span><span class="p">,</span> <span class="na">placeholder</span><span class="p">:</span> <span class="dl">"</span><span class="s2">jsmith</span><span class="dl">"</span> <span class="p">},</span>
        <span class="na">password</span><span class="p">:</span> <span class="p">{</span> <span class="na">label</span><span class="p">:</span> <span class="dl">"</span><span class="s2">Password</span><span class="dl">"</span><span class="p">,</span> <span class="na">type</span><span class="p">:</span> <span class="dl">"</span><span class="s2">password</span><span class="dl">"</span> <span class="p">},</span>
      <span class="p">},</span>
      <span class="k">async</span> <span class="nx">authorize</span><span class="p">(</span><span class="nx">credentials</span><span class="p">,</span> <span class="nx">req</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="p">{</span> <span class="nx">csrfToken</span><span class="p">,</span> <span class="nx">_id</span> <span class="p">}</span> <span class="o">=</span> <span class="nx">credentials</span><span class="p">;</span>

        <span class="k">await</span> <span class="nx">dbConnect</span><span class="p">();</span>

        <span class="kd">const</span> <span class="nx">user</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">User</span><span class="p">.</span><span class="nx">findOne</span><span class="p">({</span>
          <span class="c1">// collectionì´ë¦„  : credentials ì†ì„± ì´ë¦„</span>
          <span class="na">username</span><span class="p">:</span> <span class="nx">username</span><span class="p">,</span>
          <span class="na">password</span><span class="p">:</span> <span class="nx">password</span><span class="p">,</span>
        <span class="p">});</span>

        <span class="k">if</span> <span class="p">(</span><span class="nx">user</span><span class="p">)</span> <span class="p">{</span>
          <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">"</span><span class="s2">new user</span><span class="dl">"</span><span class="p">,</span> <span class="nx">user</span><span class="p">);</span>
          <span class="k">return</span> <span class="nx">user</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
          <span class="k">return</span> <span class="kc">null</span><span class="p">;</span>
        <span class="p">}</span>
      <span class="p">},</span>
    <span class="p">}),</span>
  <span class="p">],</span>
<span class="p">});</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<blockquote>
  <p><code class="language-plaintext highlighter-rouge">dbConnect</code> êµ¬í˜„ì€ ë‹¤ìŒ ê¸°íšŒì— ë‹¤ë£¨ê¸°ë¡œ í•˜ê² ë‹¤.</p>
</blockquote>

<p>ë‚´ìš© ì‘ì„±ì´ ëë‚¬ë‹¤ë©´ ì„œë²„ë¥¼ êµ¬ë™ì‹œí‚¤ê³  <a href="http://localhost:3000/api/auth/signin" target="\_blank">http://localhost:3000/api/auth/signin</a> ë¡œ ì ‘ì†í•˜ë©´ ë§Œë“¤ì§€ë„ ì•Šì•˜ëŠ”ë° ë¡œê·¸ì¸ í˜ì´ì§€ê°€ ëœ¬ë‹¤.</p>

<p><code class="language-plaintext highlighter-rouge">mongodb</code>ì— ì„ì‹œë¡œ ìœ ì € ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ë©´ ë¸Œë¼ìš°ì € ê°œë°œìë„êµ¬ì—ì„œ <code class="language-plaintext highlighter-rouge">Application</code> íƒ­ì— ì¿ í‚¤ë¥¼ ë³´ë©´ <code class="language-plaintext highlighter-rouge">next auth session</code>ì†ì„±ì´ ì¶”ê°€ëœ ê²ƒì„ í™•ì¸ í•  ìˆ˜ ìˆë‹¤.</p>

<p>ì¶”ê°€ëœ <code class="language-plaintext highlighter-rouge">session</code>ì„ ì‚¬ìš©í•´ì„œ ì–´ë–»ê²Œ ë¡œê·¸ì¸ ìœ ì§€ê°€ ë˜ì–´ ìˆëŠ”ì§€, ìœ ì € ë°ì´í„°ëŠ” ì–´ë–»ê²Œ ê°€ì ¸ì™€ì„œ ë¿Œë¦¬ëŠ”ì§€ ë‹¤ìŒ ì‹œê°„ì— ì•Œì•„ë³´ì.</p>

<blockquote>
  <p>22.06.07 ê¸°ì¤€, ìµœê·¼ ì‘ì„±ë˜ëŠ” í¬ìŠ¤íŒ…ì€ ì‹œê°„ ì‚¬ì •ìƒ ë¹ ë¥´ê²Œ ê¸°ë¡í•˜ëŠ” ê²ƒì„ ëª©í‘œë¡œ í•©ë‹ˆë‹¤. ê³„ì†í•´ì„œ ì‰¬ëŠ” ë‚ ì— ì—…ë°ì´íŠ¸ ì˜ˆì •ì´ë‹ˆ ì°¸ê³ ë°”ëë‹ˆë‹¤ ğŸ™‡â€â™‚ï¸</p>
</blockquote>

<hr />

<p>ğŸ“š í•¨ê»˜ ë³´ë©´ ì¢‹ì€ ë‚´ìš©</p>

<p><a href="https://next-auth.js.org/configuration/providers/credentials" target="\_blank">NextAuth.js::Credentials</a></p>

<p><a href="https://next-auth.js.org/configuration/callbacks" target="\_blank">NextAuth.js::Callbacks</a></p>

<p><a href="https://next-auth.js.org/getting-started/rest-api" target="\_blank">NextAuth.js::REST API</a></p>
:ET