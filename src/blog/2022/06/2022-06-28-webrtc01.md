---
slug: "/webrtc01/"
layout: post
date: 2022-06-28 00:58:39 +0900
title: "[WEBRTC] node.js express + React + WebRTC + WebSocket í™˜ê²½ êµ¬ì¶•í•˜ê¸° 01"
author: Kimson
categories: [software]
image: /images/post/covers/TIL-center.png
tags: [node, express, react, webrtc, websocket, til]
description: "node.js express + React í™˜ê²½ êµ¬ì¶•ë¶€í„° í•´ë³´ì

ì´ë²ˆì— WebRTCì™€ webSocketì„ ì¡°ì‚¬í•´ì•¼í•  ì¼ì´ ìƒê²¨ì„œ ë¶€ë´ë¶€ë´ ì´ë¡ ì„ ë³´ê³ , í…ŒìŠ¤íŠ¸í•´ë³´ê¸° ìœ„í•´ ì—¬ëŸ¬ ë¸”ë¡œê·¸ì™€ ë¬¸ì„œë¥¼ ì°¾ì•„ë‹¤ë…”ìŠµë‹ˆë‹¤. ì´ë¯¸ ì–´ë ¤ìš´ê±¸ ì§€ê¸ˆë¶€í„° í•´ì•¼í•œë‹¤ë‹ˆ... ë³µ ë°›ì€ê±´ê°€
ë¨¼ì € Nextì—ì„œ ì§„í–‰í•˜ë ¤ê³  í–ˆìœ¼ë‚˜ WebRTCë¥¼ ì„¤ì •í•˜ëŠ”ë° ìˆì–´ì„œ node.jsë„ ê³µë¶€í•´ ë³¼ ê²¸ nodeì™€ reactë¥¼ ê²°í•©í•œ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ í•´ë³´ë ¤í•©ë‹ˆë‹¤.

webrtc_testë¼ëŠ” í´ë”ë¥¼ ë§Œë“¤ê³  ì´ë™í•©ë‹ˆë‹¤.
"
featured: true
hidden: false
rating: 4.5
toc: true
profile: false
istop: true
keysum: false
keywords: ""
published: true
---

# node.js express + React í™˜ê²½ êµ¬ì¶•ë¶€í„° í•´ë³´ì

ì´ë²ˆì— WebRTCì™€ webSocketì„ ì¡°ì‚¬í•´ì•¼í•  ì¼ì´ ìƒê²¨ì„œ ë¶€ë´ë¶€ë´ ì´ë¡ ì„ ë³´ê³ , í…ŒìŠ¤íŠ¸í•´ë³´ê¸° ìœ„í•´ ì—¬ëŸ¬ ë¸”ë¡œê·¸ì™€ ë¬¸ì„œë¥¼ ì°¾ì•„ë‹¤ë…”ìŠµë‹ˆë‹¤. ì´ë¯¸ ì–´ë ¤ìš´ê±¸ ì§€ê¸ˆë¶€í„° í•´ì•¼í•œë‹¤ë‹ˆ... <del>ë³µ ë°›ì€ê±´ê°€</del>

ë¨¼ì € Nextì—ì„œ ì§„í–‰í•˜ë ¤ê³  í–ˆìœ¼ë‚˜ WebRTCë¥¼ ì„¤ì •í•˜ëŠ”ë° ìˆì–´ì„œ node.jsë„ ê³µë¶€í•´ ë³¼ ê²¸ nodeì™€ reactë¥¼ ê²°í•©í•œ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸ í•´ë³´ë ¤í•©ë‹ˆë‹¤.

webrtc_testë¼ëŠ” í´ë”ë¥¼ ë§Œë“¤ê³  ì´ë™í•©ë‹ˆë‹¤.

```bash
mkdir webrtc_test && cd "$_"
```

ê·¸ë¦¬ê³  clientë””ë ‰í† ë¦¬ë¥¼ ë¨¼ì € ë§Œë“¤ì–´ ì¤„ í…ë°ìš”. reactí”„ë¡œì íŠ¸ë¥¼ ë§Œë“­ë‹ˆë‹¤.

```bash
npm install -g create-react-app # create-react-appì´ ì—†ë‹¤ë©´ ì„¤ì¹˜í•´ì£¼ì„¸ìš”!
npx create-react-app client
```

## node.js express WebSocket ì„¤ì •

clientì—ì„œëŠ” êµ³ì´ ì„¤ì¹˜í•  ì¢…ì†ì„±ì€ ì—†ìœ¼ë‹ˆ ë°”ë¡œ nodeë„ ì„¸íŒ…í•´ì¤ë‹ˆë‹¤. webrtc_testë¥¼ ë£¨íŠ¸ë¡œ ì¡ê³  ì•„ë˜ ëª…ë ¹ì¤„ì„ ì´ì–´ì„œ ì…ë ¥í•©ë‹ˆë‹¤.

```bash
npm install express
```

ì°¸ê³ ë¡œ íŒŒì¼êµ¬ì¡°ëŠ” ì•„ë˜ì™€ ê°™ì´ ìƒì„±ë˜ì–´ì•¼ í•©ë‹ˆë‹¤.

![íŒŒì¼êµ¬ì¡°](https://user-images.githubusercontent.com/71887242/175982631-2c417f1f-e658-4dbb-9771-f9d70842a3bd.png)

expressê°€ ì„¤ì¹˜ë˜ë©´ serverë””ë ‰í† ë¦¬ë¥¼ ìƒì„±í•˜ê³  ê·¸ ì•ˆì— server.jsë¥¼ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤.

```bash
mkdir server/ && cd "$_" && touch server.js
```

appê³¼ socketServerë¥¼ ë”°ë¡œ ë§Œë“­ë‹ˆë‹¤. ì´ê²Œ ë§ëŠ” ë°©ë²•ì¸ì§€ëŠ” ëª¨ë¥´ê² ìŠµë‹ˆë‹¤ë§Œ ì‘ë™ì´ ë˜ëŠ” ì ì—ì„œ ì¼ë‹¨ ì´ëŒ€ë¡œ ì§„í–‰ì„ í–ˆìŠµë‹ˆë‹¤. ì¶”í›„ ë” ì•Œì•„ë³´ê³  ìˆ˜ì •í•˜ë ¤í•©ë‹ˆë‹¤.

```javascript
// server.js

const express = require("express");
const app = express();
const socketServer = express();
const index = require("./Router/index");

app.use("/", index);

const appport = 4000;
app.listen(appport, () => console.log(4000));

const port = 5000;
const HTTPServer = socketServer.listen(port, () => console.log(`${port}`));

// websocket ì„œë²„ë¥¼ ìœ„í•œ wsëª¨ë“ˆ ìƒì„±í•©ë‹ˆë‹¤.
const { WebSocketServer } = require("ws");
const webSocketServer = new WebSocketServer({
  server: HTTPServer, // WebSocketì„œë²„ì— ì—°ê²°í•  HTTPì„œë²„ë¥¼ ì§€ì •í•œë‹¤.
  // port: 30002, // WebSocketì—°ê²°ì— ì‚¬ìš©í•  portë¥¼ ì§€ì •í•œë‹¤(ìƒëµì‹œ, httpì„œë²„ì™€ ë™ì¼í•œ port ê³µìœ  ì‚¬ìš©)
  // noServer: true
  // ìœ„ ì†ì„±ë“¤ì€ ì…‹ ì¤‘ í•˜ë‚˜ë§Œ ì„¤ì •í•´ì•¼í•©ë‹ˆë‹¤.
});

// or

const wsModule = require("ws");
const webSocketServer = wsModule.Server({
  server: HTTPServer, // WebSocketì„œë²„ì— ì—°ê²°í•  HTTPì„œë²„ë¥¼ ì§€ì •í•œë‹¤.
  // port: 30002, // WebSocketì—°ê²°ì— ì‚¬ìš©í•  portë¥¼ ì§€ì •í•œë‹¤(ìƒëµì‹œ, httpì„œë²„ì™€ ë™ì¼í•œ port ê³µìœ  ì‚¬ìš©)
  // noServer: true
  // ìœ„ ì†ì„±ë“¤ì€ ì…‹ ì¤‘ í•˜ë‚˜ë§Œ ì„¤ì •í•´ì•¼í•©ë‹ˆë‹¤.
});
```

ê·¸ ë‹¤ìŒìœ¼ë¡œ ì´ë²¤íŠ¸ ì²˜ë¦¬í•˜ëŠ” êµ¬ë¬¸ì„ ì‘ì„±í•©ë‹ˆë‹¤.

```javascript
// server.js
// ìœ„ì— ì¼ë˜ ì½”ë“œë“¤...

webSocketServer.on("connection", (ws, request) => {
  console.log(`í´ë¼ì´ì–¸íŠ¸ ì ‘ì†`);

  // í´ë¼ì´ì–¸íŠ¸ë¡œ ë©”ì‹œì§€ ì „ì†¡
  if (ws.readyState === ws.OPEN) {
    ws.send(`ì„œë²„ ì ‘ì† ì™„ë£Œ`); // ë°ì´í„° ì „ì†¡
  }

  // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì˜¨ ë©”ì‹œì§€ ìˆ˜ì‹  ì´ë²¤íŠ¸ ì²˜ë¦¬
  ws.on("message", (msg) => {
    console.log(`ìˆ˜ì‹ í•œ ë©”ì‹œì§€ : ${msg}`);
    ws.send("ìˆ˜ì‹  ì™„ë£Œ");
  });

  // ì—ëŸ¬ ì´ë²¤íŠ¸ ì²˜ë¦¬
  ws.on("error", (e) => {
    console.log(`ì—°ê²° ì—ëŸ¬ë°œìƒ : ${e}`);
  });

  // ì—°ê²° ì¢…ë£Œ ì´ë²¤íŠ¸ ì²˜ë¦¬
  ws.on("close", () => {
    console.log(`ì—°ê²° ì¢…ë£Œ`);
  });
});
```

íŒŒì¼êµ¬ì¡°ë¥¼ ì°¸ê³ í•˜ì‹œë©´ server.jsê°€ ìœ„ì¹˜í•œ ê³³ì— router ë””ë ‰í† ë¦¬ë¥¼ ë§Œë“¤ê³  ê·¸ ì•ˆì— index.jsë¥¼ ë§Œë“­ë‹ˆë‹¤. nodeì—ì„œ ì‚¬ìš©í•  í˜ì´ì§€ì…ë‹ˆë‹¤.

```bash
mkdir router/ && "$_"
touch index.js
```

ê·¸ ë‹¤ìŒ ì•„ë˜ì™€ ê°™ì´ ì•„ë¬´ ë‚´ìš©ì´ë‚˜ ì ì–´ë‘¡ë‹ˆë‹¤. ë‹¨ì§€ url ì—°ê²°ì´ ì˜ ë˜ëŠ”ì§€ ë³´ê¸°ìœ„í•¨ ì…ë‹ˆë‹¤.

```javascript
const express = require("express");
const router = express.Router();

router.get("/", function (req, res) {
  res.send(
    `Lorem ipsum dolor sit, amet consectetur adipisicing elit. Pariatur, magni?`
  );
});

module.exports = router;
```

ì´ì œ ì„œë²„ ìª½ì€ ëë‚¬ìŠµë‹ˆë‹¤.

## React WebSocket + WebRTC ì„¤ì •

í´ë¼ì´ì–¸íŠ¸ì—ì„œ WebSocket ê´€ë ¨í•´ì„œëŠ” ë°›ì„ê²Œ ì—†ìŠµë‹ˆë‹¤. ë‹¤ ë‚´ì¥ë˜ì–´ ìˆëŠ” ê¸°ëŠ¥ë“¤ì´ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.

ë¨¼ì € ë¶ˆí•„ìš”í•œ cssì™€ App.jsì˜ ë‚´ìš©ì„ ëª¨ë‘ ë‚ ë ¤ë²„ë¦¬ê³  ì‘ì„±í•©ë‹ˆë‹¤.

```jsx
import React, { useEffect, useRef, useState } from "react";

const webSocket = new WebSocket("ws://localhost:5000");

// ì—°ê²° ì´ë²¤íŠ¸
webSocket.onopen = () => {
  alert(`ì„œë²„ ì—°ê²°!`);
};

// ë©”ì„¸ì§€ ì´ë²¤íŠ¸
webSocket.onmessage = function (e) {
  console.log(`Server >> ${e.data}`);
};

// ì¢…ë£Œ ì´ë²¤íŠ¸
webSocket.onclose = function () {
  console.log("ì„œë²„ ì—°ê²° ì¢…ë£Œ");
};

// ì—ëŸ¬ ì´ë²¤íŠ¸
webSocket.onerror = function (e) {
  console.log(e);
};

function App() {
  const videoRef = useRef();
  const [isConnect, setIsConnect] = useState(null);
  const [value, setValue] = useState("");

  const handleSubmit = (e) => {
    e.preventDefault();
    webSocket.send(value);
    setValue("");
    return false;
  };

  const handleValue = (e) => {
    setValue(e.target.value);
  };

  const handleClose = function () {
    if (webSocket.readyState === webSocket.OPEN) {
      webSocket.close(); // ì„œë²„ ì—°ê²° ì¢…ë£Œ
    } else {
      alert("ì—°ê²°ëœ ì„œë²„ê°€ ì—†ìŠµë‹ˆë‹¤.");
    }
  };

  useEffect(() => {
    if (webSocket.readyState === webSocket.OPEN) {
      setIsConnect(true);
    }
    var constraints = {
      video: true,
    };

    var video = videoRef.current;

    function handleSuccess(stream) {
      window.stream = stream;
      video.srcObject = stream;
    }

    function handleError(error) {
      console.log("getUserMedia error: ", error);
    }

    window.navigator.mediaDevices
      ?.getUserMedia(constraints)
      .then((d) => {
        return handleSuccess(d);
      })
      .catch((d) => {
        return handleError(d);
      });
  }, []);

  return (
    <div>
      <div>
        {isConnect ? <span>ì—°ê²° ë˜ì—ˆìŠµë‹ˆë‹¤.</span> : <span>ì—°ê²° ì¤‘...</span>}
      </div>
      <form onSubmit={handleSubmit}>
        {isConnect && (
          <input
            type='text'
            placeholder='ë©”ì„¸ì§€ ì…ë ¥'
            value={value}
            onChange={handleValue}
          />
        )}
      </form>
      <video ref={videoRef} autoPlay playsInline></video>
      <button id='btn_close' onClick={handleClose}>
        close
      </button>
    </div>
  );
}
```

ì´ì œ RTC ì„¤ì •ë„ ëë‚¬ìœ¼ë‹ˆ ì˜ ì‘ë™ë˜ëŠ”ì§€ ë´ì•¼í•©ë‹ˆë‹¤. íŠ¹íˆë‚˜ ì¹´ë©”ë¼ ê¶Œí•œì„ ìš”ì²­í•˜ê³  ì •ìƒì ìœ¼ë¡œ videoì— ì¹´ë©”ë¼ë¥¼ ì—°ê²°í•´ì£¼ëŠ”ì§€ë¥¼ìš”.

ì—¬ê¸°ì„œ ì¤‘ìš”í•œ ì ì´ ìˆìŠµë‹ˆë‹¤. reactë¥¼ ê·¸ëƒ¥ ì‹¤í–‰í•˜ë©´ http í”„ë¡œí† ì½œë¡œ ì‹¤í–‰ ë©ë‹ˆë‹¤. ì¹´ë©”ë¼ ê¶Œí•œì€ https í”„ë¡œí† ì½œë¡œ ë³´ì•ˆì—°ê²°ì´ ë˜ì–´ì•¼ ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ì´ ë©ë‹ˆë‹¤. httpëŠ” ë³´ì•ˆì´ ì·¨ì•½í•´ì„œ ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ì´ ì œí•œë˜ì–´ ì•„ë¬´ëŸ° ë°˜ì‘ì„ í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤!

ì´ê²ƒ ë•Œë¬¸ì— 3ì‹œê°„ì„ ë²„ë ¸ìŠµë‹ˆë‹¤... ğŸ¥²

reactë¡œ httpsë¥¼ ë§í•˜ëŠ” ì´ìœ ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ WebRTCë¥¼ ì„¤ì •í–ˆê¸° ë•Œë¬¸ì— reactë¥¼ httpsë¡œ ì‹¤í–‰í•´ì•¼í•œë‹¤ëŠ” ë§ì…ë‹ˆë‹¤. ì°¸ê³ ë¡œ nodeì—ì„œ httpsë¡œ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì€ ë§ìŠµë‹ˆë‹¤.

1. mkcertë¥¼ ì„¤ì¹˜í•´ì„œ ê°€ì§œ ì¸ì¦ì„œë¥¼ ë°›ê³  ì‹¤í–‰í•œë‹¤.
2. letsencrypt-win-simpleë¡œ ì¸ì¦ì„œ ë°›ê³  ì‹¤í–‰í•œë‹¤.
3. nodeì˜ https.createServerë¥¼ ì‚¬ìš©í•œë‹¤.
4. ë“±ë“±

í•˜ì§€ë§Œ reactë¥¼ httpsë¡œ í•˜ë ¤ë©´ ì–´ë–»ê²Œ í•´ì•¼í• ê¹Œìš”?

ê°„ë‹¨í•˜ì§€ë§Œ ë³´ì•ˆ ì·¨ì•½ì„±ì„ ì—¼ë‘ì— ë‘ê³  ë¬¸ì œê°€ ì—†ë‹¤ë©´ ì‚¬ìš©í•˜ì‹œê¸° ë°”ëë‹ˆë‹¤. macì— ëŒ€í•´ì„œ httpsë¥¼ ì„¤ì •í•˜ëŠ” ë°©ë²•ì€ ì°¾ì•˜ì§€ë§Œ ì •ì‘ ì €ëŠ” windowë¼ ì´ê²ƒì €ê²ƒ ì‹œë„ë¥¼ í•´ë´¤ìŠµë‹ˆë‹¤.

ì–´ë µì§€ì•Šê²Œ ì•Œ ìˆ˜ ìˆì—ˆëŠ”ë°ìš”, ì•„ë˜ì™€ ê°™ì´ clientë””ë ‰í† ë¦¬ì—ì„œ .envíŒŒì¼ì„ ìƒì„±í•˜ê³  HTTPSì†ì„±ì„ ì¶”ê°€ë§Œí•´ì£¼ë©´ httpsë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.

```properties
HTTPS=true

# í•„ìš”ì‹œ
HOST=0.0.0.0
PORT=3000
```

ì´ë ‡ê²Œ ì„¤ì •í•˜ê³  ê·¸ëƒ¥ ì‹¤í–‰í•˜ë©´ ë©ë‹ˆë‹¤. ë¬¼ë¡  nodeì¼œê³ , reactí‚¤ëŠ”ê²Œ ë¶ˆí¸í•˜ê² ì£ . ê·¸ë˜ì„œ concurrentlyë¥¼ ì„¤ì¹˜í•´ì„œ expressê°€ ì„¤ì¹˜ëœ package.jsonì„ ì¢€ ë§Œì ¸ì¤ë‹ˆë‹¤.

ë¨¼ì € í•„ìš”í•œ ì¢…ì†ì„±ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.

```bash
npm install nodemon concurrently --save
```

> ì €ëŠ” yarnì„ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— ë‹¤ì†Œ ë‹¤ë¥¼ ìˆ˜ ìˆëŠ” ë¶€ë¶„ì´ ìˆìŠµë‹ˆë‹¤. npmì„ ì‚¬ìš©í•˜ì‹ ë‹¤ë©´ ê·¸ì— ë§ê²Œ ëª…ë ¹ì¤„ì„ ìˆ˜ì •í•´ì£¼ì„¸ìš”

ê·¸ë¦¬ê³  package.jsonì„ ì•„ë˜ì™€ ê°™ì´ ë§ˆì € ìˆ˜ì •í•©ë‹ˆë‹¤.

```json
{
  // ...

  "scripts": {
    "server": "cd server && nodemon server.js",
    "client": "cd client && npm start",
    "start": "concurrently --kill-others-on-fail \"yarn server\" \"yarn client\""
  },
  
  // ...
}
```

yarn start í•´ë³´ë©´ 3000, 4000, 5000 í¬íŠ¸ê°€ ì—´ë¦¬ê³  ì ‘ì†í•´ì„œ í…ŒìŠ¤íŠ¸ í•´ë´…ë‹ˆë‹¤.

3000ì€ react, 4000ì€ express indexí˜ì´ì§€, 5000ì€ ì›¹ì†Œì¼“ ì„œë²„ì…ë‹ˆë‹¤.

ë¨¼ì € ì‹¤í–‰ëœ reactë¥¼ ë³´ë©´ ì•„ë˜ì™€ ê°™ì´ ëœ¨ë©´ ì„±ê³µì…ë‹ˆë‹¤! ì´ë¯¸ ì—¬ëŸ¬ ë²ˆ ì‹œë„í•œ ì €ëŠ” ì¹´ë©”ë¼ ê¶Œí•œ ìš”ì²­ì´ ë‹¤ì‹œ ëœ¨ì§€ ì•Šì§€ë§Œ ì²˜ìŒ ì‹œì‘í•  ë•ŒëŠ” ìš”ì²­ì´ ì˜¬ ê²ƒ ì…ë‹ˆë‹¤.

![ëŒ€ì„±ê³µ](https://user-images.githubusercontent.com/71887242/175993053-09a8c513-c53e-43b7-b99e-2a72623cf58c.png)

ì½˜ì†”ì—ì„œëŠ” ì›¹ì†Œì¼“ì´ ì—°ê²°ë˜ì—ˆê³ , node consoleì—ì„œë„ ì—°ê²°ë˜ì—ˆë‹¤ê³  ëœ¨ë©´ ëŒ€ì„±ê³µì…ë‹ˆë‹¤! ğŸ˜

> ì˜ìƒì´ ë°˜ëŒ€ë¡œ ë‚˜ì˜µë‹ˆë‹¤. ë”°ë¡œ ì„¤ì •í•˜ì‹œë ¤ë©´ ë°˜ëŒ€ë¡œ ë’¤ì§‘ìœ¼ì‹œê¸¸...

---

ğŸ“š í•¨ê»˜ ë³´ë©´ ì¢‹ì€ ë‚´ìš©

[ì•ˆë†ì´ë‹˜ ë¸”ë¡œê·¸::\[webRTC\] ì›¹RTC ì˜ˆì œë¡œ í™”ìƒ ì±„íŒ… êµ¬í˜„í•˜ê¸°.](https://dksshddl.tistory.com/entry/webRTC-%EC%9B%B9RTC-%EC%98%88%EC%A0%9C%EB%A1%9C-%ED%99%94%EC%83%81-%EC%B1%84%ED%8C%85-%EA%B5%AC%ED%98%84%ED%95%98%EA%B8%B0)

[ptvandi::generate-dev-ssl-cert.sh](https://gist.github.com/ptvandi/5a33c28d74ccc5100d7fe2bf5de96deb)

[MDN web docs::WebRTC API](https://developer.mozilla.org/ko/docs/Web/API/WebRTC_API)